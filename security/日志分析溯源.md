## 识别攻击源IP

### 1. 扫描探测

​        演习期间，很多局点扫描探测类日志占所有攻击日志（IPS）的90%以上，此类日志主要来源于自研/开源全网扫描器、僵尸网络发起的自动化感染传播

​        攻击者利用FOFA、ZOOMEYE进行资产收集，并对C段进行扫描。如果出现连续的端口扫描日志或者Nmap等目录扫描工具信息的日志，可预判是攻击方进行探测。

​        攻击方进行扫描器扫描，分为主动扫描或挂代理转发式的被动扫描。这种扫描会在短时间内出现一个源IP对一个目标服务器大量的SQL注入、XSS等攻击，由此可判定为攻击方。特点：日志量大，攻击源IP相对固定，扫描产生的日志类型较多（很多客户网络是部署有负载均衡和反向代理设备的，需要获取到日志的真实源IP才能进行针对性的防护，切忌直接封堵，以免影响业务）

### 2. 手工试探

​       值得注意：高水准的对抗演戏中，攻击方不会进行盲目扫描，而是谨慎地手工尝试，这类尝试性日志容易被扫描日志淹没。

​       比如攻击方找到上传点，会进行手工上传测试，找到疑似Struts2，ThinkPHP框架的系统，会用开源工具或者带编码绕过的自研工具进行尝试，在登录框进行SQL手工尝试，或者用Shiro反序列化工具尝试等。

​        这些攻击流量产生的日志数量极少，却不能被防守方轻易忽略，可以针对最近一年或近年爆出的漏洞、以及客户资产情况，进行有针对性的日志搜索，一旦发现，可以进行封堵或加固，同时顺藤摸瓜，或去态势感知等平台上进行上下文关联，进一步判断攻击是否成功、摸出攻击者意图。这类能反映攻击方意图的尝试类IPS检测规则列表，可以在实战中加以总结和积累。

### 3. 异常属性类

​        考虑到攻方可能将扫描器和C2服务器部署在个人VPS上，而这些VPS极有可能是个人购买的云服务

​        对于IP归属地是国内外的云服务商的情况都需要加以关注。有的攻击方会在深夜乘防守方警惕性降低时进行攻击尝试，因此半夜出现的新增攻击日志源，也值得警惕。

​        攻击源IP的时间属性也有一定价值，如果某个源IP只在攻防演练开始时出现日志，而之前并未出现过攻击行为，很可能来自于演练攻击方。单纯从攻击日志的各类属性特点来分析日志，也能起到一定作用，当然以上方法结合分析，效果更好。

​        NOD（Newly Observed Domain），域名也是可疑的观察对象之一。在演习前突然新增的域名，极有可能是红队为活动前做的准备。对于这类NOD域名可以提前分析获取，加入关注名单。一旦产生类似的外联日志，哪怕原有的情报和态势系统没有告警，也建议马上行动，展开失陷资产排查，并向前溯源，最大程度的还原攻击路径。

## 关注重点事件日志

​        中后期更需要关注一些重点事件，及时发现包括0day、新增外联、内网异常行为之类的风险

### 1. 木马连接类

​        日常检测中，一旦发现木马远控连接工具，包括Cobalt Strike的命令下发流量（HTTP协议）和证书指纹规则（HTTPS协议），MSF自带木马Meterpreter及各类开源远控等的痕迹，以及这些工具通信流量产生的日志都需要警醒，这预示着内网已有机器失陷

### 2. 代理隧道类

​        在获取权限后，攻击方通常会使用代理工具搭建隧道进入内网，以获得稳定的控制权限。。一旦出现代理隧道的日志，也说明形势较为危急，预示着攻击方可能已经打入内网。

### 3. 横向扫描类

​        利用代理隧道进入内网的攻击方，可能通过Ladon等工具进行网段、端口、服务的探测，以及使用爆破，撞库的方式进行内网密码破解。因此由内网IP发起的扫描探测日志如果被部署在内网的安全设备检测上报，那么这些日志也是非常值得关注的。

​        这几类重点事件的日志，一般表明有系统被攻陷，因此这些规则需要在演习之前保持开启状态，且演习期间关注级别很高，即使出现的日志条数只有一条，也要优先介入分析。这也对蓝军攻防基础提出了一定的要求，初级防守方人员可以联动后台攻防实验室进行有效协同，中高级守方人员可以在实战中进行攻击负载和技战法的总结，形成经验智库。







dirsearch 目录扫描

`python3 dirsearch.py --random-agent -r -t 50 -e php --plain-text-report=C:118.txt -u http://140.206.223.59:8080/`



## Web应急排查

### Shiro攻击

1. 特征：rememberMe值伪造

2. 排查思路：该漏洞都是通过rememberMe进行传入payload，直接对日志中shiro进行反编译即可查到相关信息（vps、未公开的利用链、特殊的payload）

   得到rememberMe的cookie值 -> Base64解码 -> AES-128-CBC解密-> 反序列化(readobject)

**蓝队实战溯源反制**：https://sec.nmask.cn/article_content?a_id=81963be55e7e0658827dca12219ddc75